machine:
  post:
    - pyenv install --skip-existing 2.7.12
    - pyenv install --skip-existing 3.4.5
    - pyenv install --skip-existing 3.5.2
    - pyenv install --skip-existing 3.6.2
    - pyenv global 2.7.12 3.4.5 3.5.2 3.6.2


dependencies:
  cache_directories:
    - /opt/circleci/python
    - ./.tox/py27
    - ./.tox/py34
    - ./.tox/py35
    - ./.tox/py36

  override:
    - pip install -r ops/requirements.txt -r ops/devrequirements.txt
    - tox --notest  # Install all the envs so they get cached


test:
  override:
    - peltak lint
    - tox
    - peltak docs

  post:
    - mv docs/html .build/docs
    - cp .build/test-results.xml $CIRCLE_TEST_REPORTS/
    - mv .build/** "$CIRCLE_ARTIFACTS/"


deployment:
  pypi:
    branch: master
    commands:
      - peltak release gen-pypirc
      - peltak release upload pypi
      - rm ~/.pypirc
      - peltak release tag
      - "git push origin v$(peltak version show --porcelain)"

